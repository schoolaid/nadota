# MorphTo Filter Configuration Fix

## Issues Fixed

### Issue 1: Options Format Inverted (FIXED)

**Problem**: The type filter options were showing with label and value swapped.

**Expected**:
```json
{
  "key": "targetable_type",
  "options": [
    { "label": "Student", "value": "student" },
    { "label": "Family", "value": "user" }
  ]
}
```

**Actual (incorrect)**:
```json
{
  "key": "targetable_type",
  "options": [
    { "label": "student", "value": "Student" },
    { "label": "user", "value": "User" }
  ]
}
```

**Root Cause**: In `MorphToFilter::formatMorphTypes()`, the array was formatted as `[$alias => $label]` (e.g., `['student' => 'Student']`). When `Filter::toArray()` processes options, it uses the array key as the label and value as the value, causing the inversion.

**Fix**: Changed `formatMorphTypes()` to return `[$label => $alias]` (e.g., `['Student' => 'student']`).

**File Changed**: `/src/Http/Filters/MorphToFilter.php` (lines 117-135)

---

### Issue 2: Missing Morph Endpoint Pattern (FIXED)

**Problem**: The entity filter endpoint was using the regular pattern instead of the morph pattern.

**Expected**:
```json
{
  "key": "targetable_id",
  "endpoint": "/nadota-api/form-target/resource/field/targetable/morph-options/{morphType}",
  "props": {
    "isMorphEndpoint": true,
    "endpointTemplate": "/nadota-api/form-target/resource/field/targetable/morph-options/{morphType}"
  }
}
```

**Actual (incorrect)**:
```json
{
  "key": "targetable_id",
  "endpoint": "/nadota-api/form-target/resource/field/targetable_id/options"
}
```

**Root Cause**: In `FilterableTrait::createMorphToFilters()` (lines 419-425), it tried to get the parent resource by calling `$this->getResource()` on the MorphTo field. However, `RelationshipTrait::getResource()` returns the **related** resource class, not the **parent** resource. So `$resourceKey` was null, and the morph endpoint wasn't set in `MorphToFilter::generateFilters()`.

**Fix**:
1. Added `asMorphFilter(string $fieldName)` method to `DynamicSelectFilter` to mark it as a morph filter
2. Modified `DynamicSelectFilter::getEndpointUrl()` to build morph endpoints dynamically from the request when the morph filter flag is set
3. Updated `MorphToFilter::generateFilters()` to use `asMorphFilter()` instead of trying to set the endpoint with a resourceKey

**Files Changed**:
- `/src/Http/Filters/DynamicSelectFilter.php`:
  - Added properties: `$isMorphFilter`, `$morphFieldName` (line 24-25)
  - Added method: `asMorphFilter()` (lines 155-165)
  - Modified: `getEndpointUrl()` to build morph endpoints (lines 249-259)
- `/src/Http/Filters/MorphToFilter.php`:
  - Simplified `generateFilters()` to use `asMorphFilter()` (lines 95-102)

---

### Issue 3: Hardcoded Label Suffix (FIXED)

**Problem**: The type filter label had " - Tipo" concatenated, breaking frontend translation.

**Expected**:
```json
{
  "key": "targetable_type",
  "label": "fields.targetable_type"
}
```

**Actual (incorrect)**:
```json
{
  "key": "targetable_type",
  "label": "fields.targetable - Tipo"
}
```

**Root Cause**: In `MorphToFilter::generateFilters()` line 82, the filter name was created as `$this->name . ' - Tipo'`, hardcoding the suffix.

**Fix**: Modified label generation to use translation key pattern:
- If name contains `.` (translation key): Convert `fields.targetable` → `fields.targetable_type`
- If name doesn't contain `.`: Keep original (backward compatible)

**Pattern**:
```
fields.targetable          → fields.targetable_type
resources.forms.commentable → resources.forms.commentable_type
Targetable                  → Targetable (no change)
```

**File Changed**: `/src/Http/Filters/MorphToFilter.php` (lines 78-106)

---

## How It Works Now

When `MorphTo::make()->filterable()` is called:

1. `FilterableTrait::createMorphToFilters()` creates a `MorphToFilter` instance
2. `MorphToFilter::generateFilters()` returns two filters:
   - **Type Filter** (`SelectFilter`): With options formatted as `[label => alias]`
   - **Entity Filter** (`DynamicSelectFilter`): Marked as morph filter via `asMorphFilter()`

3. When filters are serialized to JSON via `toArray($request)`:
   - Type filter options are processed by `Filter::toArray()` which creates `[{label: key, value: value}]` → Produces `[{label: "Student", value: "student"}]` ✓
   - Entity filter endpoint is built by `DynamicSelectFilter::getEndpointUrl()` which detects it's a morph filter and builds `/morph-options/{morphType}` endpoint ✓
   - `DynamicSelectFilter::props()` detects the endpoint contains `{morphType}` and sets `isMorphEndpoint: true` and `endpointTemplate` ✓

## Testing

To test the fix, check the filter configuration for a MorphTo field:

```bash
GET /nadota-api/form-target/resource/config
```

Look for the two filters generated by the MorphTo field:

1. **Type Filter** should have:
   - `options` with correct label/value (label is capitalized, value is lowercase alias)

2. **Entity Filter** should have:
   - `endpoint` matching pattern `/morph-options/{morphType}`
   - `props.isMorphEndpoint: true`
   - `props.endpointTemplate` with the placeholder

Both filters should work correctly in the frontend now.
